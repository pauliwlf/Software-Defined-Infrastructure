# Excersise 13: Working on Cloud-init with Terraform

### 1. Objective

The goal of this exercise was to extend our base system deployment by using Cloud-init with Terraform to automatically configure a secure web server.
Key requirements were:

- Deploy an Nginx web server with a custom landing page.
- Enable inbound HTTP traffic (port 80) via firewall configuration.
- Harden SSH access (no password login, no root login).
- Create a devops user with SSH key and sudo privileges.
- Upgrade the Debian 12 distribution during server creation.
- Install and configure fail2ban for protection against repeated failed SSH login attempts.
- Install and initialize the plocate file indexer.

### 2. Terraform and Cloud-init Configuration

**2.1 Firewall Setup**  
The firewall configuration allowed inbound traffic for:

- SSH (TCP port 22) for secure administration.
- HTTP (TCP port 80) for Nginx.

Example snippet:

```hcl
resource "hcloud_firewall" "exercise_13_firewall" {
  name = "exercise-13-firewall"

rule {
  direction = "in"
  protocol = "tcp"
  port = "22"
  source_ips = ["0.0.0.0/0", "::/0"]
  description = "SSH inbound"
}

rule {
  direction = "in"
  protocol = "tcp"
  port = "80"
  source_ips = ["0.0.0.0/0", "::/0"]
  description = "HTTP inbound"
  }
}
```

**2.2 Cloud-init User Data Script**  
A Cloud-init script was included in the Terraform configuration. It performed the following tasks automatically at server creation:

- Installed and started Nginx, and enabled it to start on reboot.
- Updated and upgraded all Debian packages.
- Disabled SSH password authentication.
- Disabled root login.
  Created user `devops` with sudo privileges and SSH key access.
- Installed and configured fail2ban.
- Installed and initialized **plocate** for fast file searching.

### 3. Security and Access Configuration

- **Password login disabled**
  Configured in `/etc/ssh/sshd_config`:

```hcl
PasswordAuthentication no
PermitRootLogin no
```

- **Root login disabled**
  Attempting `ssh root@<ip>`now returns:

```hcl
Please login as the user "NONE" rather than the user "root".
```

- **Created `devops` user**
  Login works via:

```hcl
ssh devops@<server-ip>
```

- **Sudo access confirmed**
  The `devops` user can switch to root:

```hcl
sudo su -
```

### 4. Verification of the Web Server

After deployment, visiting the serverâ€™s IP in a browser displayed the custom Nginx landing page:

```hcl
I'm Nginx @ "37.27.219.19" created Wed Jul 30 11:14:38 PM UTC 2025
```

This confirmed that:

- Nginx was installed correctly.
- The firewall allowed inbound traffic on port 80.
- The landing page was deployed via Cloud-init.

### 5. System Update at Creation

The Cloud-init script updated and upgraded the Debian 12 system packages automatically during initialization. Verification with:

```hcl
sudo apt update
```

Output confirmed:

```hcl
All packages are up to date.
```

### 6. Fail2ban Configuration

Fail2ban was installed and configured to monitor SSH login attempts.

Verification command:

`````hcl
sudo fail2ban-client status sshd````

Expected output includes information about failed login attempts and banned IP addresses:
```hcl
|- Currently banned: 2
|- Total banned: 2
`- Banned IP list: 170.64.133.30 213.136.94.219
`````

### 7. Plocate Installation

The `plocate` package was installed and initialized to enable fast file searches.  
Tested with:

```hcl
locate ssh_host
```

Output listed SSH host key files:

```hcl
/etc/ssh/ssh_host_ed25519_key
/etc/ssh/ssh_host_ed25519_key.pub
```
