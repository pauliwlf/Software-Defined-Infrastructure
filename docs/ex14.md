# Exercise 14: Solving the `~/.ssh/known_hosts` Quirk

### 1. Objective

The aim of this exercise was to resolve the recurring problem of **SSH host key verification warnings** (or failures) when provisioning new servers via Terraform.
The solution required automatically generating a **known_hosts** file and wrapper scripts for ssh and scp to ensure smooth, secure access without manual confirmations.

### 2. Project Setup

A new project folder **Excercice_14** was created with the following structure:

```hcl
Excercice_14/
    tpl/         # Template scripts for ssh/scp
    bin/         # Generated wrapper scripts
    gen/         # Generated SSH keys and knwn_hosts
    main.tf      # Terraform configuration
    outputs.tf   # Terraform outputs
    cloud_init.yml
```

### 3. Templates for Wrapper Scripts

**3.1 SSH Wrapper Template (tpl/ssh.sh)**

```hcl
#!/usr/bin/env bash
GEN_DIR=$(dirname "$0")/../gen
ssh -o UserKnownHostsFile="$GEN_DIR/known_hosts" ${devopsUsername}@${ip} "$@"
```

- `${devopsUsername}` and `${ip}` are replaced by Terraform using templatefile().
- The `"$@"` allows optional additional SSH arguments.

### 3.2 SCP Wrapper Template (`tpl/scp.sh`)

```tf
#!/usr/bin/env bash
GEN_DIR=$(dirname "$0")/../gen

if [ $# -lt 2 ]; then
   echo "usage: .../bin/scp <source> <destination>"
else
   scp -o UserKnownHostsFile="$GEN_DIR/known_hosts" "$@"
fi
```

- Ensures at least two arguments are passed (source and destination).
- Uses the same custom known_hosts file as the SSH wrapper.

### 4. Terraform Configuration

**4.1 Providers and Keys**

- Added the tls and local providers in addition to hetznercloud/hcloud.
- Generated an ED25519 key pair via Terraform:

```tf
resource "tls_private_key" "devops_key" {
  algorithm = "ED25519"
}
```

- Stored the keys in the gen/ directory.
- Registered the public key in Hetzner with:

```tf
resource "hcloud_ssh_key" "devops_key" {
  name       = "exercise14-key"
  public_key = tls_private_key.devops_key.public_key_openssh
}
```

**4.2 Known Hosts File**
Terraform generated a gen/known_hosts file containing the server IP and host key fingerprint.
This file ensures SSH does not show host key verification warnings.

**4.3 Server Creation**

- Created a Debian 12 server with Cloud-init.
- Attached the devops SSH key.
- Added firewall rules for SSH (22) and HTTP (80).

### 5. Cloud-init Configuration

The Cloud-init script was reused from **Exercise 13** and ensured:

- Installation and enabling of Nginx.
- Creation of a `devops` user with sudo privileges.
- Disabled password authentication (`ssh_pwauth: false`).
- Disabled root login (`disable_root: true`).

### 6. Testing and Verification

**6.1 Terraform Apply**
Execution of:

```tf
terraform apply
```

Output confirmed:

```tf
Apply complete! Resources: 9 added, 0 changed, 0 destroyed.

Outputs:
server_datacenter = "hel1-dc2"
server_ip         = "95.216.223.223"
```

**6.2 Using the SSH Wrapper**

```tf
./bin/ssh
```

- Successfully logged into the server as devops.
- No host key warnings appeared.

**6.3 File Transfer with SCP Wrapper**

```tf
echo "Hello from Pauline" > localfile.txt
./bin/scp localfile.txt devops@95.216.223.223:/home/devops/
```

On the server:

```tf
ls -l /home/devops/
cat /home/devops/localfile.txt
```

Output:

```tf
Hello from Pauline
```

Confirmed that file transfer works correctly.
