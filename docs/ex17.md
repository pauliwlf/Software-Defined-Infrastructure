# Exercise 17: SSH Known Hosts Module

1. Objective

The objective of this exercise was to create a **reusable Terraform** module called `SshKnownHosts` that automatically generates:

- a `known_hosts` file,
- SSH and SCP wrapper scripts

so that connecting to servers can be done securely and consistently without repeating configuration snippets in every project.

## 2. Project Structure

We organized the project into two main directories:

```br
.
   KnownHostsByModule
      bin
          ssh
          scp
      gen
          known_hosts
      main.tf
      network.tf
      outputs.tf
      providers.tf
      Readme.md
      tpl
          userData.yml
      variables.tf
    Modules
      SshKnownHosts
          main.tf
          Readme.md
          tpl
          ssh.sh
          scp.sh
          variables.tf
```

- **Modules/SshKnownHosts**: reusable Terraform module for known_hosts handling
- **KnownHostsByModule**: main project using the module

## 3. Module Definition

Variables (`Modules/SshKnownHosts/variables.tf`)

```tf
variable "loginUserName" {
  description = "The SSH login user"
  type        = string
}

variable "serverNameOrIp" {
  description = "Server IPv4 address or hostname"
  type        = string
}

variable "serverHostPublicKey" {
  description = "The server's host public key"
  type        = string
}
```

### Resources (`Modules/SshKnownHosts/main.tf`)

**Generate known_hosts**

```tf
resource "local_file" "known_hosts" {
  content  = "${var.serverNameOrIp} ${var.serverHostPublicKey}"
  filename = "${path.module}/../KnownHostsByModule/gen/known_hosts"
}
```

**Generate ssh wrapper**

```tf
resource "local_file" "ssh_script" {
  content = templatefile("${path.module}/tpl/ssh.sh", {
    loginUser = var.loginUserName
    server_ip = var.serverNameOrIp
  })
  filename        = "${path.module}/../KnownHostsByModule/bin/ssh"
  file_permission = "700"
}
```

**Generate scp wrapper**

```tf
resource "local_file" "scp_script" {
  content = templatefile("${path.module}/tpl/scp.sh", {
    loginUser = var.loginUserName
    server_ip = var.serverNameOrIp
  })
  filename        = "${path.module}/../KnownHostsByModule/bin/scp"
  file_permission = "700"
}
```

## 4. Wrapper Templates

`tpl/ssh.sh`

```tf
#!/bin/bash
GEN_DIR=$(dirname "$0")/../gen
ssh -o UserKnownHostsFile="$GEN_DIR/known_hosts" ${loginUser}@${server_ip} "$@"
```

`tpl/scp.sh`

```tf
#!/bin/bash
GEN_DIR=$(dirname "$0")/../gen

if [ $# -lt 2 ]; then
   echo "Usage: ./bin/scp <source> <destination>"
else
   scp -o UserKnownHostsFile="$GEN_DIR/known_hosts" "$@"
fi
```

## 5. Module Usage in Main Project

```tf
module "createSshKnownHosts" {
  source             = "../Modules/SshKnownHosts"
  loginUserName      = hcloud_ssh_key.loginUser.name
  serverNameOrIp     = hcloud_server.exercise_14.ipv4_address
  serverHostPublicKey = tls_private_key.host.public_key_openssh
}
```

## 6. Verification

1. Applied Terraform configuration:

```tf
terraform apply
```

2. Confirmed generation of:

- `gen/known_hosts`
- Executable scripts in `bin/ssh` and `bin/scp`

3. Set permissions:

```tf
chmod +x bin/ssh bin/scp
```

4. Tested SSH login:

```tf
./bin/ssh
```

→ Logged in successfully without host key warning.

5. Tested SCP file transfer:

```tf
./bin/scp localfile.txt devops@<server_ip>:/home/devops/
```

→ File appeared on server.
